import{Client as e}from"https://cdn.jsdelivr.net/npm/@gradio/client@1.11.0/dist/index.min.js";let client=await e.connect("AmMoPy/werdos"),cache=new Map;async function getFileHash(e){if(!window.crypto||!window.crypto.subtle)return`${e.name}-${e.size}`;{let t=await e.arrayBuffer(),a=await crypto.subtle.digest("SHA-256",t),n=Array.from(new Uint8Array(a)),l=n.map(e=>e.toString(16).padStart(2,"0")).join("");return l}}async function compressImage(e){return new Promise(t=>{let a=new FileReader;a.onload=a=>{let n=new Image;n.src=a.target.result,n.onload=()=>{let a=document.createElement("canvas"),l=a.getContext("2d"),i=n.width,r=n.height;i>r?i>224&&(r*=224/i,i=224):r>224&&(i*=224/r,r=224),a.width=i,a.height=r,l.drawImage(n,0,0,i,r),a.toBlob(a=>{t(new File([a],e.name,{type:"image/jpeg"}))},"image/jpeg",.8)}},a.readAsDataURL(e)})}async function classifyImage(e){let t=await getFileHash(e);if(cache.has(t))return cache.get(t);let a=document.querySelector("header");a.classList.add("siren-effect");try{let n=await compressImage(e),l=await client.predict("/predict",{img:n});return cache.set(t,l.data),l.data}catch(i){return console.error("Error classifying image:",i),alert("An error occurred while classifying the image. Please try again."),null}finally{a.classList.remove("siren-effect")}}let privacyLink=document.getElementById("privacy-link"),privacyPopup=document.getElementById("privacy-popup"),closePrivacyPopup=document.getElementById("close-privacy-popup"),acceptPrivacyPolicy=document.getElementById("accept-privacy-policy"),rejectPrivacyPolicy=document.getElementById("reject-privacy-policy"),privacyCheckbox=document.getElementById("privacy-checkbox"),uploadButton=document.getElementById("image-upload");function displayResult(e,t){let a=document.getElementById("results"),n=document.createElement("div");n.className="result-item";let l=document.createElement("img");l.src=URL.createObjectURL(e),l.alt="Uploaded Image",n.appendChild(l);let i=document.createElement("div");i.className="bar-chart",t[0].confidences.forEach(e=>{let t=document.createElement("div");t.className="bar";let a=document.createElement("div");a.className="bar-label",a.textContent=`${e.label} ${Math.round(100*e.confidence)}%`,t.appendChild(a);let n=document.createElement("div");n.className="bar-progress";let l=document.createElement("div");l.className="bar-fill",l.style.width=`${100*e.confidence}%`,n.appendChild(l),t.appendChild(n),i.appendChild(t)}),n.appendChild(i),a.appendChild(n),document.getElementById("results-section").style.display="block"}privacyLink.addEventListener("click",e=>{e.preventDefault(),privacyPopup.style.display="block"}),closePrivacyPopup.addEventListener("click",()=>{privacyPopup.style.display="none"}),acceptPrivacyPolicy.addEventListener("click",()=>{privacyCheckbox.disabled=!1,privacyCheckbox.checked=!0,uploadButton.disabled=!1,privacyPopup.style.display="none"}),rejectPrivacyPolicy.addEventListener("click",()=>{privacyCheckbox.disabled=!0,privacyCheckbox.checked=!1,uploadButton.disabled=!0,privacyPopup.style.display="none",alert("You must accept the Privacy Policy to upload images.")}),privacyCheckbox.addEventListener("change",()=>{uploadButton.disabled=!privacyCheckbox.checked}),document.getElementById("image-upload").addEventListener("change",async e=>{let t=e.target.files;if(!t||0===t.length){console.error("No files selected.");return}for(let a of t)if(!a.type.startsWith("image/")){alert("Only image files are allowed."),e.target.value="";return}let n=await fetch("https://ipapi.co/json/").then(e=>e.json()).then(e=>e.ip).catch(()=>(console.error("Failed to fetch IP address"),"Unknown IP"));Array.from(t).forEach(e=>{console.log(`Image uploaded by IP: ${n}, File: ${e.name}, Size: ${e.size}, Type: ${e.type}`)});let l=Array.from(t).map(async e=>{let t=await classifyImage(e);t&&displayResult(e,t)});await Promise.all(l)});let exampleImages=["black_cat_looking_at_camera.jpeg","black_cat_wearing_light_beige_garment.jpeg","cat_and_dog_playing_in_kitchen.png","cat_hanging_from_pet_carrier.jpeg","cat_resting_on_wooden_table.jpeg","dog_black_and_white.png","dog_in_robe_and_sunglasses_sitting_on_couch_with_popcorn_bowl.png","dog_looking_through_door.png","dog_on_surfboard_in_ocean_with_hawaiian_lei_lei_around_his_neck.png","dog_sitting_in_chair_with_black_board.jpg","dog_wearing_hoodie.jpg","dog_with_black_nose.jpg","ginger_white_cat_sits_legs_apart_on_bed.jpeg","grey_white_Italian_Greyhound_dog.jpeg","light_orange_ginger_cat_infront_slightly_open_window_at_night.jpeg","low_angle_view_of_orange_tabby_cat_sitting_upright.jpeg","orange_white_cat_sitting_on_floor.jpeg","two_dogs_wearing_hats_on_bed.png"],examplesContainer=document.getElementById("examples-container");function createImageElement(e){let t=document.createElement("img");return t.src=`inf_cs/${e}`,t.alt=`Image of a ${e.replace(/_/g," ").replace(/.jpeg|.jpg|.png/g,"")}`,t.className="example-image",t.addEventListener("click",async()=>{let a=await fetch(t.src),n=await a.blob(),l=new File([n],e,{type:n.type}),i=await classifyImage(l);i&&displayResult(l,i)}),t}function enableDragScroll(e){let t=document.getElementById(e),a=!1,n,l;function i(){t.style.animationPlayState="paused"}function r(){t.style.animationPlayState="running"}function c(){t.scrollLeft<0?t.scrollLeft=0:t.scrollLeft>t.scrollWidth-t.clientWidth&&(t.scrollLeft=t.scrollWidth-t.clientWidth)}t.addEventListener("touchstart",e=>{a=!0,n=e.touches[0].pageX-t.offsetLeft,l=t.scrollLeft,i()}),t.addEventListener("touchmove",e=>{if(!a)return;e.preventDefault();let i=e.touches[0].pageX-t.offsetLeft,r=(i-n)*4;t.scrollTo({left:l-r,behavior:"smooth"}),c()}),t.addEventListener("touchend",()=>{a=!1,r()}),t.addEventListener("mousedown",e=>{a=!0,n=e.pageX-t.offsetLeft,l=t.scrollLeft,t.style.cursor="grabbing",i()}),t.addEventListener("mousemove",e=>{if(!a)return;e.preventDefault();let i=e.pageX-t.offsetLeft,r=(i-n)*4;t.scrollTo({left:l-r,behavior:"smooth"}),c()}),t.addEventListener("mouseup",()=>{a=!1,t.style.cursor="grab",r()}),t.addEventListener("mouseleave",()=>{a=!1,t.style.cursor="grab",r()}),t.addEventListener("mouseenter",()=>{i()}),t.addEventListener("mouseleave",()=>{a||r()})}exampleImages.forEach(e=>{examplesContainer.appendChild(createImageElement(e))}),exampleImages.forEach(e=>{examplesContainer.appendChild(createImageElement(e))}),document.getElementById("clear-results").addEventListener("click",()=>{let e=document.getElementById("results");e.innerHTML="",document.getElementById("results-section").style.display="none"}),enableDragScroll("examples-container"),enableDragScroll("results");