const cache=new Map;async function getFileHash(e){if(!window.crypto||!window.crypto.subtle)return`${e.name}-${e.size}`;{let t=await e.arrayBuffer(),a=await crypto.subtle.digest("SHA-256",t),l=Array.from(new Uint8Array(a)),n=l.map(e=>e.toString(16).padStart(2,"0")).join("");return n}}async function compressImage(e){return new Promise(t=>{let a=new FileReader;a.onload=a=>{let l=new Image;l.src=a.target.result,l.onload=()=>{let a=document.createElement("canvas"),n=a.getContext("2d"),i=l.width,c=l.height;i>c?i>224&&(c*=224/i,i=224):c>224&&(i*=224/c,c=224),a.width=i,a.height=c,n.drawImage(l,0,0,i,c),a.toBlob(a=>{t(new File([a],e.name,{type:"image/jpeg"}))},"image/jpeg",.8)}},a.readAsDataURL(e)})}async function classifyImage(e){let t=await getFileHash(e);if(cache.has(t))return cache.get(t);document.getElementById("loading").style.display="block";try{let a=await compressImage(e),l=new FormData;l.append("image",a);let n=await fetch("/api/predict",{method:"POST",body:l});if(!n.ok)throw Error("Failed to classify image");let i=await n.json();return cache.set(t,i.predictions),i.predictions}catch(c){return console.error("Error classifying image:",c),alert("An error occurred while classifying the image. Please try again."),null}finally{document.getElementById("loading").style.display="none"}}function displayResult(e,t){let a=document.getElementById("results"),l=document.createElement("div");l.className="result-item";let n=document.createElement("img");n.src=URL.createObjectURL(e),n.alt="Uploaded Image",l.appendChild(n);let i=document.createElement("div");i.className="bar-chart",t[0].confidences.forEach(e=>{let t=document.createElement("div");t.className="bar";let a=document.createElement("div");a.className="bar-label",a.textContent=`${e.label} ${Math.round(100*e.confidence)}%`,t.appendChild(a);let l=document.createElement("div");l.className="bar-progress";let n=document.createElement("div");n.className="bar-fill",n.style.width=`${100*e.confidence}%`,l.appendChild(n),t.appendChild(l),i.appendChild(t)}),l.appendChild(i),a.appendChild(l),debounceCheckScroll()}document.getElementById("image-upload").addEventListener("change",async e=>{let t=e.target.files;if(!t||0===t.length)return;let a=Array.from(t).map(async e=>{let t=await classifyImage(e);t&&displayResult(e,t)});await Promise.all(a)});const exampleImages=["black_cat_looking_at_camera.jpeg","black_cat_wearing_light_beige_garment.jpeg","cat_and_dog_playing_in_kitchen.png","cat_hanging_from_pet_carrier.jpeg","cat_resting_on_wooden_table.jpeg","dog_black_and_white.png","dog_in_robe_and_sunglasses_sitting_on_couch_with_popcorn_bowl.png","dog_looking_through_door.png","dog_on_surfboard_in_ocean_with_hawaiian_lei_lei_around_his_neck.png","dog_sitting_in_chair_with_black_board.jpg","dog_wearing_hoodie.jpg","dog_with_black_nose.jpg","ginger_white_cat_sits_legs_apart_on_bed.jpeg","grey_white_Italian_Greyhound_dog.jpeg","light_orange_ginger_cat_infront_slightly_open_window_at_night.jpeg","low_angle_view_of_orange_tabby_cat_sitting_upright.jpeg","orange_white_cat_sitting_on_floor.jpeg","two_dogs_wearing_hats_on_bed.png"],examplesContainer=document.getElementById("examples-container");function createImageElement(e){let t=document.createElement("img");return t.src=`inf_cs/${e}`,t.alt=`Image of a ${e.replace(/_/g," ").replace(/.jpeg|.jpg|.png/g,"")}`,t.className="example-image",t.addEventListener("click",async()=>{let a=await fetch(t.src),l=await a.blob(),n=new File([l],e,{type:l.type}),i=await classifyImage(n);i&&displayResult(n,i)}),t}exampleImages.forEach(e=>{examplesContainer.appendChild(createImageElement(e))}),exampleImages.forEach(e=>{examplesContainer.appendChild(createImageElement(e))}),document.getElementById("clear-results").addEventListener("click",()=>{let e=document.getElementById("results");e.innerHTML="",debounceCheckScroll()});let debounceTimeout;function debounceCheckScroll(){clearTimeout(debounceTimeout),debounceTimeout=setTimeout(checkScroll,100)}function checkScroll(){let e=document.getElementById("results"),t=document.getElementById("scroll-left"),a=document.getElementById("scroll-right");e.scrollWidth>e.clientWidth?(t.style.display="block",a.style.display="block"):(t.style.display="none",a.style.display="none")}checkScroll(),window.addEventListener("resize",debounceCheckScroll),document.getElementById("scroll-left").addEventListener("click",()=>{document.getElementById("results").scrollBy({left:-200,behavior:"smooth"})}),document.getElementById("scroll-right").addEventListener("click",()=>{document.getElementById("results").scrollBy({left:200,behavior:"smooth"})});