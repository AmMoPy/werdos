<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLOOFS Classifier</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <h1>Troubled FLOOFS</h1>
      <p>Upload an image and let our AI classify it for you!</p>
      <div class="upload-options">
        <label for="single-upload" class="btn">Upload Single Image</label>
        <input type="file" id="single-upload" accept="image/*" style="display: none;">
        <label for="multiple-upload" class="btn">Upload Multiple Images</label>
        <input type="file" id="multiple-upload" accept="image/*" multiple style="display: none;">
      </div>
      <div id="loading" class="loading" style="display: none;">
        <div class="loader"></div>
        <p>Resolving Identity Crisis...</p>
      </div>
    </div>
  </header>

  <!-- Results Section -->
  <section id="results-section">
    <div class="container">
      <h2>Final Verdict</h2>
      <div id="results" class="results-grid"></div>
      <button id="clear-results" class="btn">New FLOOFS</button>
      <div class="scroll-arrows">
        <button class="scroll-arrow" id="scroll-left">&#10094;</button>
        <button class="scroll-arrow" id="scroll-right">&#10095;</button>
      </div>
    </div>
  </section>

  <!-- Examples Section -->
  <section id="examples">
    <div class="container">
      <h2>FLOOFS Having Severe Identity Crisis</h2>
      <div class="example-grid-wrapper">
        <div class="example-grid" id="examples-container"></div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <p>Â© 2025 FLOOFS Classifier. All rights reserved.</p>
      <div class="footer-links">
        <a href="https://github.com/ammopy" target="_blank">GitHub</a>
        <a href="https://huggingface.co/ammopy" target="_blank">Hugging Face</a>
        <a href="https://github.com/ammopy/zaps" target="_blank">Zaps</a>
        <a href="mailto:amr.haleem@gmail.com">Contact</a>
      </div>
    </div>
  </footer>

  <script type="module">
  import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@1.11.0/dist/index.min.js";

  // Connect to the Gradio app
  const client = await Client.connect("AmMoPy/werdos");

  // Cache for API responses
  const cache = new Map();

  // Function to generate a unique hash for a file
  async function getFileHash(file) {
    // If the crypto.subtle API is available, use it to generate a hash
    if (window.crypto && window.crypto.subtle) {
      const arrayBuffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest("SHA-256", arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      return hashHex;
    } else {
      // Fallback: Use file name and size as a unique identifier
      return `${file.name}-${file.size}`;
    }
  }

  // Function to compress an image
  async function compressImage(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const MAX_WIDTH = 224; // Adjust as needed 800
          const MAX_HEIGHT = 224; // Adjust as needed 800
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: "image/jpeg" }));
          }, "image/jpeg", 0.8); // Adjust quality as needed
        };
      };
      reader.readAsDataURL(file);
    });
  }

  // Function to classify an image
  async function classifyImage(file) {
    const cacheKey = await getFileHash(file);
    if (cache.has(cacheKey)) {
      return cache.get(cacheKey);
    }

    // Show loading animation
    document.getElementById("loading").style.display = "block";

    try {
      const compressedFile = await compressImage(file);
      const result = await client.predict("/predict", { img: compressedFile });
      cache.set(cacheKey, result.data);
      return result.data;
    } catch (error) {
      console.error("Error classifying image:", error);
      alert("An error occurred while classifying the image. Please try again.");
      return null;
    } finally {
      document.getElementById("loading").style.display = "none";
    }
  }

  // Handle single image upload
  document.getElementById("single-upload").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const result = await classifyImage(file);
    if (result) {
      displayResult(file, result);
    }
  });

  // Handle multiple image upload
  document.getElementById("multiple-upload").addEventListener("change", async (event) => {
    const files = event.target.files;
    if (!files || files.length === 0) return;

    const promises = Array.from(files).map(async (file) => {
      const result = await classifyImage(file);
      if (result) {
        displayResult(file, result);
      }
    });

    await Promise.all(promises);
  });

  // Display results as bar charts
  function displayResult(file, result) {
    const resultsContainer = document.getElementById("results");
    const resultItem = document.createElement("div");
    resultItem.className = "result-item";

    // Display image
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.alt = "Uploaded Image";
    resultItem.appendChild(img);

    // Display bar chart for each result
    const barChart = document.createElement("div");
    barChart.className = "bar-chart";

    result[0].confidences.forEach((confidence) => {
      const bar = document.createElement("div");
      bar.className = "bar";

      const barLabel = document.createElement("div");
      barLabel.className = "bar-label";
      barLabel.textContent = `${confidence.label} ${Math.round(confidence.confidence * 100)}%`;
      bar.appendChild(barLabel);

      const barProgress = document.createElement("div");
      barProgress.className = "bar-progress";

      const barFill = document.createElement("div");
      barFill.className = "bar-fill";
      barFill.style.width = `${confidence.confidence * 100}%`;
      barProgress.appendChild(barFill);

      bar.appendChild(barProgress);
      barChart.appendChild(bar);
    });

    resultItem.appendChild(barChart);
    resultsContainer.appendChild(resultItem);

    // Check if scrolling is needed after adding new results
    debounceCheckScroll();
  }

  // Array of example image filenames
  const exampleImages = [
    "d_1.jpeg", "d_2.jpg", "d_3.jpg", "d_5.jpg", "d_6.png", "d_7.png", "d_8.png", "d_9.png", "d_10.png", 
    "d_11.png", "c.jpeg", "c_1.jpeg", "c_3.jpeg", "c_4.jpeg", "c_5.jpeg", "c_6.jpeg", "c_7.jpeg", "c_8.jpeg"
  ];

  // Get the container where example images will be displayed
  const examplesContainer = document.getElementById("examples-container");

  // Function to create an image element
  function createImageElement(image) {
    const img = document.createElement("img");
    img.src = `inf_cs/${image}`;
    img.alt = "cats_dogs_floofs Image";
    img.className = "example-image";
    img.addEventListener("click", async () => {
      const response = await fetch(img.src);
      const blob = await response.blob();
      const file = new File([blob], image, { type: blob.type });
      const result = await classifyImage(file);
      if (result) {
        displayResult(file, result);
      }
    });
    return img;
  }

  // Add images to the grid twice to create a seamless loop
  exampleImages.forEach((image) => {
    examplesContainer.appendChild(createImageElement(image));
  });

  // Duplicate the images for seamless scrolling
  exampleImages.forEach((image) => {
    examplesContainer.appendChild(createImageElement(image));
  });

  // Clear all results
  document.getElementById("clear-results").addEventListener("click", () => {
    const resultsContainer = document.getElementById("results");
    resultsContainer.innerHTML = "";
    debounceCheckScroll();
  });

  // Debounce checkScroll to reduce unnecessary calls
  let debounceTimeout;
  function debounceCheckScroll() {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(checkScroll, 100);
  }

  // Function to check if scrolling is needed
  function checkScroll() {
    const resultsContainer = document.getElementById("results");
    const scrollLeftArrow = document.getElementById("scroll-left");
    const scrollRightArrow = document.getElementById("scroll-right");

    if (resultsContainer.scrollWidth > resultsContainer.clientWidth) {
      scrollLeftArrow.style.display = "block";
      scrollRightArrow.style.display = "block";
    } else {
      scrollLeftArrow.style.display = "none";
      scrollRightArrow.style.display = "none";
    }
  }

  // Call the function initially and on window resize
  checkScroll();
  window.addEventListener("resize", debounceCheckScroll);

  // Scroll arrows functionality
  document.getElementById("scroll-left").addEventListener("click", () => {
    document.getElementById("results").scrollBy({ left: -200, behavior: "smooth" });
  });

  document.getElementById("scroll-right").addEventListener("click", () => {
    document.getElementById("results").scrollBy({ left: 200, behavior: "smooth" });
  });
  </script>
</body>
</html>